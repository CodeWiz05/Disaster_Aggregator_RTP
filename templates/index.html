
{% extends "base.html" %}

{% block title %}DisasterTrack - Real-time Disaster Monitoring{% endblock %}

{% block styles %} {# Matches block name in base.html #}
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {# --- Leaflet CSS (Removed integrity/crossorigin) --- #}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.3/leaflet.css" />
    {# FontAwesome link (If needed specifically here, otherwise remove if in base) #}
    {# <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" /> #}
    {# Add any index-specific styles here if needed #}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.Default.css"/>
    <style>
        /* Add specific styles for index elements if not in main styles.css */
        .filters-panel.hidden { display: none; }
        .data-wrapper.card-view .table-responsive { display: none; }
        .data-wrapper.card-view .card-grid { display: grid; /* Or flex */ }
        .data-wrapper.table-view .card-grid { display: none; }
        .data-wrapper.table-view .table-responsive { display: block; }
        .badge { /* Example badge style */ display: inline-block; padding: .25em .6em; font-size: 75%; font-weight: 700; line-height: 1; text-align: center; white-space: nowrap; vertical-align: baseline; border-radius: .25rem; }
        .badge.earthquake { background-color: #e53935; color: white; } /* Match JS colors */
        .badge.flood { background-color: #1e88e5; color: white; }
        .badge.wildfire { background-color: #fb8c00; color: white; }
        .badge.storm { background-color: #8e24aa; color: white; }
        .badge.landslide { background-color: #6d4c41; color: white; }
        .badge.other { background-color: #757575; color: white; }
        .severity-indicator { /* Example style */ font-weight: bold; }
        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--secondary-color, #2196f3); border-radius: 50%; width: 25px; height: 25px; animation: spin 1s linear infinite; margin: 0 auto 0.5rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-row td, .loading-overlay { text-align: center; color: #777; padding: 2rem; }
        .card-grid { display: none; /* Hide initially if table is default */ /* Add grid styles */ }
        .disaster-card { border: 1px solid #eee; border-radius: 4px; margin-bottom: 1rem; background: white; } /* Example */
        .card-header { padding: 0.5rem 1rem; border-bottom: 1px solid #eee; }
        .card-body { padding: 1rem; }
        .card-footer { padding: 0.5rem 1rem; border-top: 1px solid #eee; text-align: right; }
        .map-legend { /* Ensure style is defined */ position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.8); padding: 10px; border-radius: 5px; z-index: 1000; }
        .map-legend ul { list-style: none; padding: 0; margin: 0; }
        .map-legend li { margin-bottom: 3px; }
        .legend-marker { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 5px; border: 1px solid rgba(0,0,0,0.2); }
        .legend-marker.earthquake { background-color: #e53935; }
        .legend-marker.flood { background-color: #1e88e5; }
        .legend-marker.wildfire { background-color: #fb8c00; }
        .legend-marker.storm { background-color: #8e24aa; }
        .legend-marker.landslide { background-color: #6d4c41; }
        .legend-marker.other { background-color: #757575; }
    </style>
{% endblock %}


{% block content %}
{# --- Hero Section --- #}
<section class="hero-section">
    <div class="container">
        <div class="hero-content">
            <h1 class="hero-title">Real-time Disaster Monitoring</h1>
            <p class="hero-description">Stay informed about natural disasters and emergencies happening around the world.</p>
            <div class="hero-buttons">
                <a href="#disaster-map-section" class="btn btn-primary">View Map</a>
                <a href="{{ url_for('main.report') }}" class="btn btn-secondary">Report Event</a>
            </div>
        </div>
    </div>
    {# Add hero background elements if desired via CSS #}
</section>

{# --- Filters Section --- #}
<section class="filters-section">
    <div class="container">
        {# Use details/summary for accessible toggle #}
        <details class="filter-details">
             <summary class="filter-header">
                 <h2 class="section-title"><i class="fas fa-filter"></i> Filter Disasters</h2>
                 <button class="btn btn-sm btn-outline filter-toggle-btn" type="button" aria-label="Toggle Filters">
                     <i class="fas fa-chevron-down"></i> <span class="toggle-text">Show Filters</span>
                 </button>
             </summary>
             <div class="filters-panel"> {# Content shown when details is open #}
                 <div class="filters-grid">
                    {# Type Filter #}
                    <div class="filter-group">
                        <label for="filter-type"><i class="fas fa-tag"></i> Type</label>
                        <select id="filter-type" class="form-control">
                            <option value="all" selected>All Types</option>
                            <option value="earthquake">Earthquake</option>
                            <option value="flood">Flood</option>
                            <option value="wildfire">Wildfire</option>
                            <option value="storm">Storm</option>
                            <option value="landslide">Landslide</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    {# Severity Filter #}
                    <div class="filter-group">
                        <label for="filter-severity"><i class="fas fa-exclamation-circle"></i> Min Severity</label>
                        <select id="filter-severity" class="form-control">
                            <option value="1" selected>Any (1+)</option>
                            <option value="2">Moderate (2+)</option>
                            <option value="3">Significant (3+)</option>
                            <option value="4">Severe (4+)</option>
                            <option value="5">Extreme (5)</option>
                        </select>
                    </div>
                    {# Time Period Filter #}
                    <div class="filter-group">
                        <label for="filter-days"><i class="far fa-calendar-alt"></i> Time Period</label>
                        <select id="filter-days" class="form-control">
                            <option value="1">Last 24 hours</option>
                            <option value="7" selected>Last 7 days</option>
                            <option value="30">Last 30 days</option>
                            <option value="90">Last 90 days</option>
                            <option value="0">All time</option>
                        </select>
                    </div>
                    {# Region Filter (Placeholder) #}
                    <div class="filter-group">
                        <label for="filter-region"><i class="fas fa-globe"></i> Region</label>
                        <select id="filter-region" class="form-control" disabled>
                            <option value="all" selected>Worldwide</option>
                            {# Add options later #}
                        </select>
                    </div>
                </div>
                <div class="filters-actions">
                    <button id="apply-filters" type="button" class="btn btn-primary"><i class="fas fa-check"></i> Apply Filters</button>
                    <button id="reset-filters" type="button" class="btn btn-text"><i class="fas fa-undo"></i> Reset</button>
                </div>
            </div>
        </details>
    </div>
</section>

{# --- Map Section --- #}
<section class="map-section" id="disaster-map-section">
    <div class="container">
        <div class="section-header">
            <h2 class="section-title"><i class="fas fa-map-marked-alt"></i> Disaster Map</h2>
            {# Assuming Leaflet default zoom controls are used #}
        </div>
        {# Container needs explicit height from CSS #}
        <div class="map-container">
            {# The map div - CSS must provide height #}
            <div id="disaster-map"></div>
            {# Map Legend #}
            <div class="map-legend"> {# Ensure CSS styles this #}
                <h4>Legend</h4>
                <ul>
                    <li><span class="legend-marker earthquake"></span> Earthquake</li>
                    <li><span class="legend-marker flood"></span> Flood</li>
                    <li><span class="legend-marker wildfire"></span> Wildfire</li>
                    <li><span class="legend-marker storm"></span> Storm</li>
                    <li><span class="legend-marker landslide"></span> Landslide</li>
                    <li><span class="legend-marker other"></span> Other</li>
                </ul>
            </div>
        </div>
    </div>
</section>

{# --- Recent Disasters Section --- #}
<section class="disasters-section">
    <div class="container">
        <div class="section-header">
            <h2 class="section-title"><i class="fas fa-list"></i> Recent Disasters</h2>
            {# View toggle buttons - ensure JS/CSS handles this #}
            <div class="view-controls">
                <button class="btn btn-sm btn-icon active" id="table-view" title="Table view"><i class="fas fa-table"></i></button>
                <button class="btn btn-sm btn-icon" id="card-view" title="Card view"><i class="fas fa-th-large"></i></button>
            </div>
        </div>
        {# Wrapper to toggle views #}
        <div class="data-wrapper table-view"> {# Default to table view #}
            <div class="table-responsive">
                <table class="data-table"> {# Add styles for .data-table #}
                    <thead>
                        <tr>
                            {# Add sorting indicators later if needed #}
                            <th>Title</th>
                            <th>Type</th>
                            <th>Severity</th>
                            <th>Time</th>
                            <th>Location</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="disaster-rows">
                        {# Initial loading state #}
                        <tr class="loading-row">
                            <td colspan="6">
                                <div class="loading-spinner"></div>
                                <p>Loading disaster data...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="card-grid" id="disaster-cards" style="display: none;">
                 {# Initial loading state for cards #}
                <div class="loading-overlay">
                     <div class="loading-spinner"></div>
                     <p>Loading disaster data...</p>
                 </div>
            </div>
            <div class="items-per-page-selector" style="text-align: right; margin-top: 1rem; margin-bottom: 0.5rem;">
                <label for="items-per-page" style="margin-right: 0.5rem; font-size: 0.9rem;">Items per page:</label>
                <select id="items-per-page" name="items-per-page" class="form-control" style="display: inline-block; width: auto; padding: 4px 8px;">
                    <option value="10" selected>10</option>
                    <option value="25">25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
           </div>
            {# Removed pagination controls for simplicity for now #}
            <div class="pagination-controls" style="display: flex; justify-content: center; align-items: center; gap: 1rem; margin-top: 1rem;">
                <button id="prev-page" class="btn btn-sm btn-icon" disabled><i class="fas fa-chevron-left"></i> Prev</button>
                <span id="page-info" style="font-size: 0.9rem; color: #555;">Page 1 of 1</span>
                <button id="next-page" class="btn btn-sm btn-icon" disabled>Next <i class="fas fa-chevron-right"></i></button>
            </div>
        </div>
    </div>
</section>

{# --- Statistics Section --- #}
<section class="stats-section">
    <div class="container">
         <h2 class="section-title"><i class="fas fa-chart-pie"></i> Disaster Statistics</h2>
         <div class="stats-grid">
            {# Stat Cards - ensure IDs match JS #}
            <div class="stat-card"> <div class="stat-icon"><i class="fas fa-globe"></i></div> <div class="stat-content"><h3>Total Reported</h3><div class="stat-value" id="stat-total">--</div></div> </div>
            <div class="stat-card"> <div class="stat-icon"><i class="fas fa-fire"></i></div> <div class="stat-content"><h3>Most Common</h3><div class="stat-value" id="stat-common">--</div></div> </div>
            <div class="stat-card"> <div class="stat-icon"><i class="fas fa-biohazard"></i></div> <div class="stat-content"><h3>Highest Severity</h3><div class="stat-value" id="stat-severe">--</div></div> </div>
            <div class="stat-card"> <div class="stat-icon"><i class="fas fa-clock"></i></div> <div class="stat-content"><h3>Last 7 Days</h3><div class="stat-value" id="stat-new">--</div></div> </div>
         </div>
    </div>
</section>
{% endblock %}


{% block scripts %}
{# --- Load Leaflet JS Library FIRST --- #}
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.3/leaflet.js"></script>
{# --- Load Leaflet MarkerCluster JS Library SECOND --- #}
{# --- ENSURE THIS LINE IS PRESENT AND CORRECT --- #}
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.js"></script>
{# --- Load YOUR map logic THIRD --- #}
<script src="{{ url_for('static', filename='js/map.js') }}"></script>

{# --- Inline script for PAGE-SPECIFIC functions needed by map.js --- #}
<script>
    // --- START PAGINATION Variables ---
    let currentPage = 1;
    let itemsPerPage = 10; // Default, will be updated from select
    let currentTableData = []; // Holds the FULL filtered list from map.js
    // --- END PAGINATION Variables ---

    // Define page-specific functions needed by map.js OR called locally

    function sanitizeHtml(str) {
        if (typeof str !== 'string') return '';
        const temp = document.createElement('div');
        temp.textContent = str; return temp.innerHTML;
    }

    function calculateCutoffDate(daysAgo) {
         const cutoff = new Date(); cutoff.setDate(cutoff.getDate() - daysAgo);
         cutoff.setHours(0, 0, 0, 0); return cutoff;
    }

    function handleActionClick(event) {
        const button = event.target.closest('button'); if (!button) return;
        const id = button.getAttribute('data-id'); if (!id) return;
        if (button.classList.contains('view-details')) {
            if (typeof viewDisasterDetails === 'function') { viewDisasterDetails(id); }
            else { console.error("viewDisasterDetails function not found."); }
        } else if (button.classList.contains('share-event')) {
            console.log(`Sharing event ${id} (placeholder)`);
            alert(`Sharing for ID ${id} not implemented yet.`);
        }
    }

    function attachDetailAndShareListeners() {
         const dataArea = document.querySelector('.data-wrapper'); if (!dataArea) return;
         dataArea.removeEventListener('click', handleActionClick); // Prevent duplicates
         dataArea.addEventListener('click', handleActionClick);
         // console.log("Attached detail/share listeners to data wrapper."); // Optional log
    }

    // --- UPDATE THIS FUNCTION ---
    function updateDisasterTable(filteredDisasters) {
        // Store the full filtered data if it's being passed directly
        // Otherwise, assume currentTableData already holds the full filtered list
        if (filteredDisasters && Array.isArray(filteredDisasters)) {
             currentTableData = filteredDisasters;
        } else if (!Array.isArray(currentTableData)) {
             console.error("updateDisasterTable called without valid data.");
             currentTableData = []; // Ensure it's an array
        }

        console.log("Updating disaster table. Total items:", currentTableData.length, "Items/Page:", itemsPerPage, "CurrentPage:", currentPage);

        const tableBody = document.getElementById('disaster-rows');
        const loadingRow = tableBody ? tableBody.querySelector('.loading-row') : null;

        // Clear previous content
        if (tableBody) { while (tableBody.firstChild && tableBody.firstChild !== loadingRow) { tableBody.removeChild(tableBody.firstChild); } if(loadingRow) loadingRow.style.display = 'none'; }
        else { console.warn("Table body ('disaster-rows') not found."); return; }

        // Handle empty results
        if (currentTableData.length === 0) {
            const row = document.createElement('tr');
            row.innerHTML = '<td colspan="6" style="text-align: center; padding: 1rem;">No disasters match filters.</td>';
            if (loadingRow) tableBody.insertBefore(row, loadingRow); else tableBody.appendChild(row);
            updatePaginationControls(0); // Update controls for empty state
            return;
        }

        // --- PAGINATION Calculation ---
        const totalItems = currentTableData.length;
        const totalPages = Math.ceil(totalItems / itemsPerPage) || 1; // Ensure at least 1 page
        // Adjust currentPage if it's now out of bounds (e.g., after changing itemsPerPage)
        currentPage = Math.max(1, Math.min(currentPage, totalPages));

        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const pageData = currentTableData.slice(startIndex, endIndex); // Get data for the current page
        console.log(`Displaying page ${currentPage}/${totalPages} (Items ${startIndex + 1}-${Math.min(endIndex, totalItems)} of ${totalItems})`);
        // --- END PAGINATION Calculation ---

        // Populate table rows with pageData
        pageData.forEach(disaster => { // Iterate over the SLICE
            const severity = disaster.severity || 1; const type = disaster.type || 'other';
            const severityClass = `severity-${severity}`; const typeClass = type;
            let formattedTime = 'N/A'; try { formattedTime = disaster.timestamp ? new Date(disaster.timestamp).toLocaleString(undefined, {dateStyle: 'short', timeStyle: 'short'}) : 'N/A'; } catch(e) {}
            const location = sanitizeHtml(disaster.location || disaster.description?.split('.')[0] || `[${disaster.lat?.toFixed(2)}, ${disaster.lng?.toFixed(2)}]`);
            const titleString = disaster.title || 'N/A';
            const disasterId = disaster.id || '';

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${sanitizeHtml(titleString)}</td>
                <td><span class="badge ${typeClass}">${sanitizeHtml(type)}</span></td>
                <td><span class="severity-indicator ${severityClass}">${severity}</span></td>
                <td>${formattedTime}</td>
                <td>${location.substring(0, 60)}${location.length > 60 ? '...' : ''}</td>
                <td class="actions-cell">
                    <button class="btn btn-sm btn-icon view-details" data-id="${disasterId}" title="View details"><i class="fas fa-eye"></i></button>
                    <button class="btn btn-sm btn-icon share-event" data-id="${disasterId}" title="Share"><i class="fas fa-share-alt"></i></button>
                </td>`;
            if (loadingRow) tableBody.insertBefore(row, loadingRow); else tableBody.appendChild(row);
        });

        // Update pagination controls display based on the calculated totalPages
        updatePaginationControls(totalPages);
        // Attach listeners AFTER adding rows
        attachDetailAndShareListeners();

    } // End updateDisasterTable

    // --- Function to update pagination controls (NO CHANGE NEEDED) ---
    function updatePaginationControls(totalPages) {
        const prevBtn = document.getElementById('prev-page');
        const nextBtn = document.getElementById('next-page');
        const pageInfo = document.getElementById('page-info');
        const paginationControls = document.querySelector('.pagination-controls');

        if (!paginationControls || !prevBtn || !nextBtn || !pageInfo) { console.warn("Pagination elements missing."); return; }

        if (totalPages <= 1) { paginationControls.style.display = 'none'; }
        else {
            paginationControls.style.display = 'flex';
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            prevBtn.disabled = currentPage <= 1;
            nextBtn.disabled = currentPage >= totalPages;
        }
    } // End updatePaginationControls

    // --- Function to update statistics (NO CHANGE NEEDED) ---
    function updateStatistics(dataForStats) { /* ... keep implementation ... */ }


    // --- Add event listeners for elements unique to index.html AFTER DOM is ready ---
    document.addEventListener('DOMContentLoaded', function() {
        console.log("Index.html specific DOMContentLoaded actions running.");

        // Filter toggle ... (keep listener) ...
        const filterDetails = document.querySelector('.filter-details');
        if(filterDetails) {
            // Listen to the 'toggle' event on the <details> element itself
                filterDetails.addEventListener('toggle', (event) => {
                     const isOpen = filterDetails.open;
                     const icon = toggleBtn.querySelector('i');
                     const text = toggleBtn.querySelector('span');
                     console.log("Filter toggle state changed:", isOpen);
                     if(icon) icon.className = isOpen ? 'fas fa-chevron-up' : 'fas fa-chevron-down';
                     if(text) text.textContent = isOpen ? 'Hide Filters' : 'Show Filters';
                });
                // Set initial state (optional, browser default is usually closed)
                // filterDetails.open = false; // Ensure closed initially
                // Force initial text/icon update if needed
                 const initialOpen = filterDetails.open;
                 const initialIcon = toggleBtn.querySelector('i');
                 const initialText = toggleBtn.querySelector('span');
                 if(initialIcon) initialIcon.className = initialOpen ? 'fas fa-chevron-up' : 'fas fa-chevron-down';
                 if(initialText) initialText.textContent = initialOpen ? 'Hide Filters' : 'Show Filters';   
        }
        else { console.warn("Filter details/summary elements not found."); }

        // View toggle buttons ... (keep listener) ...
        const tableViewBtn = document.getElementById('table-view');
        /* ... etc ... */
        if (tableViewBtn /*...and others...*/) { /* ... keep listener ... */ }
        else { console.warn("Table/Card view toggle elements not found."); }

        // --- START Pagination Listener Setup ---
        const prevPageBtn = document.getElementById('prev-page');
        const nextPageBtn = document.getElementById('next-page');
        const itemsPerPageSelect = document.getElementById('items-per-page');

        // Set initial itemsPerPage from select (important!)
        if (itemsPerPageSelect) {
            itemsPerPage = parseInt(itemsPerPageSelect.value, 10) || 10;
        } else {
            itemsPerPage = 10; // Fallback if select is missing
        }

        if (prevPageBtn) {
            prevPageBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    // Re-render the table using the currently stored full filtered data
                    updateDisasterTable(currentTableData);
                }
            });
        } else { console.warn("Prev Page button not found."); }

        if (nextPageBtn) {
             nextPageBtn.addEventListener('click', () => {
                // Calculate total pages based on the *stored full data* and *current itemsPerPage*
                const totalPages = Math.ceil(currentTableData.length / itemsPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    updateDisasterTable(currentTableData); // Re-render
                }
            });
        } else { console.warn("Next Page button not found."); }

        // Listener for the Items per page dropdown
        if (itemsPerPageSelect) {
            itemsPerPageSelect.addEventListener('change', (event) => {
                 const newItemsPerPage = parseInt(event.target.value, 10);
                 if (newItemsPerPage > 0 && newItemsPerPage !== itemsPerPage) { // Only update if value is valid and changed
                     console.log(`Items per page changed to: ${newItemsPerPage}`);
                     itemsPerPage = newItemsPerPage;
                     currentPage = 1; // Reset to page 1 when changing items per page
                     updateDisasterTable(currentTableData); // Re-render table with full data and new settings
                 }
            });
        } else {
            console.warn("'items-per-page' select element not found.");
        }
        // --- END Pagination Listener Setup ---

        // Other listeners (sorting placeholders, etc.)...

    }); // End index.html specific DOMContentLoaded

</script>
{# --- END Inline script --- #}
{% endblock %}