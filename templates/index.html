
{% extends "base.html" %}

{% block title %}DisasterTrack - Real-time Disaster Monitoring{% endblock %}

{% block styles %} {# Matches block name in base.html #}
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {# --- Leaflet CSS (Removed integrity/crossorigin) --- #}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.3/leaflet.css" />
    {# FontAwesome link (If needed specifically here, otherwise remove if in base) #}
    {# <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" /> #}
    {# Add any index-specific styles here if needed #}
    <style>
        /* Add specific styles for index elements if not in main styles.css */
        .filters-panel.hidden { display: none; }
        .data-wrapper.card-view .table-responsive { display: none; }
        .data-wrapper.card-view .card-grid { display: grid; /* Or flex */ }
        .data-wrapper.table-view .card-grid { display: none; }
        .data-wrapper.table-view .table-responsive { display: block; }
        .badge { /* Example badge style */ display: inline-block; padding: .25em .6em; font-size: 75%; font-weight: 700; line-height: 1; text-align: center; white-space: nowrap; vertical-align: baseline; border-radius: .25rem; }
        .badge.earthquake { background-color: #e53935; color: white; } /* Match JS colors */
        .badge.flood { background-color: #1e88e5; color: white; }
        .badge.wildfire { background-color: #fb8c00; color: white; }
        .badge.storm { background-color: #8e24aa; color: white; }
        .badge.landslide { background-color: #6d4c41; color: white; }
        .badge.other { background-color: #757575; color: white; }
        .severity-indicator { /* Example style */ font-weight: bold; }
        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--secondary-color, #2196f3); border-radius: 50%; width: 25px; height: 25px; animation: spin 1s linear infinite; margin: 0 auto 0.5rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-row td, .loading-overlay { text-align: center; color: #777; padding: 2rem; }
        .card-grid { display: none; /* Hide initially if table is default */ /* Add grid styles */ }
        .disaster-card { border: 1px solid #eee; border-radius: 4px; margin-bottom: 1rem; background: white; } /* Example */
        .card-header { padding: 0.5rem 1rem; border-bottom: 1px solid #eee; }
        .card-body { padding: 1rem; }
        .card-footer { padding: 0.5rem 1rem; border-top: 1px solid #eee; text-align: right; }
        .map-legend { /* Ensure style is defined */ position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.8); padding: 10px; border-radius: 5px; z-index: 1000; }
        .map-legend ul { list-style: none; padding: 0; margin: 0; }
        .map-legend li { margin-bottom: 3px; }
        .legend-marker { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 5px; border: 1px solid rgba(0,0,0,0.2); }
        .legend-marker.earthquake { background-color: #e53935; }
        .legend-marker.flood { background-color: #1e88e5; }
        .legend-marker.wildfire { background-color: #fb8c00; }
        .legend-marker.storm { background-color: #8e24aa; }
        .legend-marker.landslide { background-color: #6d4c41; }
        .legend-marker.other { background-color: #757575; }
    </style>
{% endblock %}


{% block content %}
{# --- Hero Section --- #}
<section class="hero-section">
    <div class="container">
        <div class="hero-content">
            <h1 class="hero-title">Real-time Disaster Monitoring</h1>
            <p class="hero-description">Stay informed about natural disasters and emergencies happening around the world.</p>
            <div class="hero-buttons">
                <a href="#disaster-map-section" class="btn btn-primary">View Map</a>
                <a href="{{ url_for('main.report') }}" class="btn btn-secondary">Report Event</a>
            </div>
        </div>
    </div>
    {# Add hero background elements if desired via CSS #}
</section>

{# --- Filters Section --- #}
<section class="filters-section">
    <div class="container">
        {# Use details/summary for accessible toggle #}
        <details class="filter-details">
             <summary class="filter-header">
                 <h2 class="section-title"><i class="fas fa-filter"></i> Filter Disasters</h2>
                 <button class="btn btn-sm btn-outline filter-toggle-btn" type="button">
                     <i class="fas fa-chevron-down"></i> <span class="toggle-text">Show Filters</span>
                 </button>
             </summary>
             <div class="filters-panel"> {# Content shown when details is open #}
                 <div class="filters-grid">
                    {# Type Filter #}
                    <div class="filter-group">
                        <label for="filter-type"><i class="fas fa-tag"></i> Type</label>
                        <select id="filter-type" class="form-control">
                            <option value="all" selected>All Types</option>
                            <option value="earthquake">Earthquake</option>
                            <option value="flood">Flood</option>
                            <option value="wildfire">Wildfire</option>
                            <option value="storm">Storm</option>
                            <option value="landslide">Landslide</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    {# Severity Filter #}
                    <div class="filter-group">
                        <label for="filter-severity"><i class="fas fa-exclamation-circle"></i> Min Severity</label>
                        <select id="filter-severity" class="form-control">
                            <option value="1" selected>Any (1+)</option>
                            <option value="2">Moderate (2+)</option>
                            <option value="3">Significant (3+)</option>
                            <option value="4">Severe (4+)</option>
                            <option value="5">Extreme (5)</option>
                        </select>
                    </div>
                    {# Time Period Filter #}
                    <div class="filter-group">
                        <label for="filter-days"><i class="far fa-calendar-alt"></i> Time Period</label>
                        <select id="filter-days" class="form-control">
                            <option value="1">Last 24 hours</option>
                            <option value="7" selected>Last 7 days</option>
                            <option value="30">Last 30 days</option>
                            <option value="90">Last 90 days</option>
                            <option value="0">All time</option>
                        </select>
                    </div>
                    {# Region Filter (Placeholder) #}
                    <div class="filter-group">
                        <label for="filter-region"><i class="fas fa-globe"></i> Region</label>
                        <select id="filter-region" class="form-control" disabled>
                            <option value="all" selected>Worldwide</option>
                            {# Add options later #}
                        </select>
                    </div>
                </div>
                <div class="filters-actions">
                    <button id="apply-filters" type="button" class="btn btn-primary"><i class="fas fa-check"></i> Apply Filters</button>
                    <button id="reset-filters" type="button" class="btn btn-text"><i class="fas fa-undo"></i> Reset</button>
                </div>
            </div>
        </details>
    </div>
</section>

{# --- Map Section --- #}
<section class="map-section" id="disaster-map-section">
    <div class="container">
        <div class="section-header">
            <h2 class="section-title"><i class="fas fa-map-marked-alt"></i> Disaster Map</h2>
            {# Assuming Leaflet default zoom controls are used #}
        </div>
        {# Container needs explicit height from CSS #}
        <div class="map-container">
            {# The map div - CSS must provide height #}
            <div id="disaster-map"></div>
            {# Map Legend #}
            <div class="map-legend"> {# Ensure CSS styles this #}
                <h4>Legend</h4>
                <ul>
                    <li><span class="legend-marker earthquake"></span> Earthquake</li>
                    <li><span class="legend-marker flood"></span> Flood</li>
                    <li><span class="legend-marker wildfire"></span> Wildfire</li>
                    <li><span class="legend-marker storm"></span> Storm</li>
                    <li><span class="legend-marker landslide"></span> Landslide</li>
                    <li><span class="legend-marker other"></span> Other</li>
                </ul>
            </div>
        </div>
    </div>
</section>

{# --- Recent Disasters Section --- #}
<section class="disasters-section">
    <div class="container">
        <div class="section-header">
            <h2 class="section-title"><i class="fas fa-list"></i> Recent Disasters</h2>
            {# View toggle buttons - ensure JS/CSS handles this #}
            <div class="view-controls">
                <button class="btn btn-sm btn-icon active" id="table-view" title="Table view"><i class="fas fa-table"></i></button>
                <button class="btn btn-sm btn-icon" id="card-view" title="Card view"><i class="fas fa-th-large"></i></button>
            </div>
        </div>
        {# Wrapper to toggle views #}
        <div class="data-wrapper table-view"> {# Default to table view #}
            <div class="table-responsive">
                <table class="data-table"> {# Add styles for .data-table #}
                    <thead>
                        <tr>
                            {# Add sorting indicators later if needed #}
                            <th>Title</th>
                            <th>Type</th>
                            <th>Severity</th>
                            <th>Time</th>
                            <th>Location</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="disaster-rows">
                        {# Initial loading state #}
                        <tr class="loading-row">
                            <td colspan="6">
                                <div class="loading-spinner"></div>
                                <p>Loading disaster data...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="card-grid" id="disaster-cards" style="display: none;">
                 {# Initial loading state for cards #}
                <div class="loading-overlay">
                     <div class="loading-spinner"></div>
                     <p>Loading disaster data...</p>
                 </div>
            </div>
            {# Removed pagination controls for simplicity for now #}
            {# <div class="pagination-controls"> ... </div> #}
        </div>
    </div>
</section>

{# --- Statistics Section --- #}
<section class="stats-section">
    <div class="container">
         <h2 class="section-title"><i class="fas fa-chart-pie"></i> Disaster Statistics</h2>
         <div class="stats-grid">
            {# Stat Cards - ensure IDs match JS #}
            <div class="stat-card"> <div class="stat-icon"><i class="fas fa-globe"></i></div> <div class="stat-content"><h3>Total Reported</h3><div class="stat-value" id="stat-total">--</div></div> </div>
            <div class="stat-card"> <div class="stat-icon"><i class="fas fa-fire"></i></div> <div class="stat-content"><h3>Most Common</h3><div class="stat-value" id="stat-common">--</div></div> </div>
            <div class="stat-card"> <div class="stat-icon"><i class="fas fa-biohazard"></i></div> <div class="stat-content"><h3>Highest Severity</h3><div class="stat-value" id="stat-severe">--</div></div> </div>
            <div class="stat-card"> <div class="stat-icon"><i class="fas fa-clock"></i></div> <div class="stat-content"><h3>Last 7 Days</h3><div class="stat-value" id="stat-new">--</div></div> </div>
         </div>
    </div>
</section>
{% endblock %}


{% block scripts %}
{# --- Load Leaflet JS Library FIRST - Removed integrity/crossorigin --- #}
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.3/leaflet.js"></script>
{# --- Load YOUR map logic SECOND --- #}
<script src="{{ url_for('static', filename='js/map.js') }}"></script>

{# --- Inline script for PAGE-SPECIFIC functions needed by map.js --- #}
<script>
    // This script block runs AFTER map.js has loaded

    // Helper Function: Basic HTML Sanitizer (needed for table/cards)
    function sanitizeHtml(str) {
        if (typeof str !== 'string') return '';
        const temp = document.createElement('div');
        temp.textContent = str; // Use browser's text setting to encode
        return temp.innerHTML;
    }

    // Function to update the disaster table (called from map.js)
    function updateDisasterTable(filteredDisasters) {
        console.log("Updating disaster table in index.html with", filteredDisasters.length, "items");
        const tableBody = document.getElementById('disaster-rows');
        const cardsContainer = document.getElementById('disaster-cards');
        const loadingRow = tableBody ? tableBody.querySelector('.loading-row') : null;
        const loadingOverlay = cardsContainer ? cardsContainer.querySelector('.loading-overlay') : null;

        // Clear previous content
        if (tableBody) { while (tableBody.firstChild && tableBody.firstChild !== loadingRow) { tableBody.removeChild(tableBody.firstChild); } if(loadingRow) loadingRow.style.display = 'none'; }
        if (cardsContainer) { while (cardsContainer.firstChild && cardsContainer.firstChild !== loadingOverlay) { cardsContainer.removeChild(cardsContainer.firstChild); } if(loadingOverlay) loadingOverlay.style.display = 'none'; }

        // Handle empty results
        if (!tableBody && !cardsContainer) { console.warn("Table/card elements not found."); return; }
        if (filteredDisasters.length === 0) {
            if (tableBody) { const row = document.createElement('tr'); row.innerHTML = '<td colspan="6" style="text-align: center; padding: 1rem;">No results match filters.</td>'; if (loadingRow) tableBody.insertBefore(row, loadingRow); else tableBody.appendChild(row); }
            if (cardsContainer) { const msg = document.createElement('p'); msg.textContent = 'No results match filters.'; msg.style.textAlign = 'center'; msg.style.padding = '2rem'; if (loadingOverlay) cardsContainer.insertBefore(msg, loadingOverlay); else cardsContainer.appendChild(msg); }
            return;
        }

        // Populate table/cards
        const pageData = filteredDisasters; // No pagination yet
        pageData.forEach(disaster => {
            const severity = disaster.severity || 1; const type = disaster.type || 'other';
            const severityClass = `severity-${severity}`; const typeClass = type;
            let formattedTime = 'N/A'; try { formattedTime = disaster.timestamp ? new Date(disaster.timestamp).toLocaleString(undefined, {dateStyle: 'short', timeStyle: 'short'}) : 'N/A'; } catch(e) {}
            // Try to get place from description if location field is missing
            const location = sanitizeHtml(disaster.location || disaster.description?.split('.')[0] || `[${disaster.lat?.toFixed(2)}, ${disaster.lng?.toFixed(2)}]`);

            // Create table row
            if (tableBody) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${sanitizeHtml(disaster.title || 'N/A')}</td>
                    <td><span class="badge ${typeClass}">${sanitizeHtml(type.charAt(0).toUpperCase() + type.slice(1))}</span></td>
                    <td><span class="severity-indicator ${severityClass}">${severity}</span></td>
                    <td>${formattedTime}</td>
                    <td>${location.substring(0, 50)}${location.length > 50 ? '...' : ''}</td> {# Truncate long locations #}
                    <td class="actions-cell">
                        <button class="btn btn-sm btn-icon view-details" data-id="${disaster.id || ''}" title="View details"><i class="fas fa-eye"></i></button>
                        <button class="btn btn-sm btn-icon share-event" data-id="${disaster.id || ''}" title="Share"><i class="fas fa-share-alt"></i></button>
                    </td>`;
                if (loadingRow) tableBody.insertBefore(row, loadingRow); else tableBody.appendChild(row);
            }

            // Create card
            if (cardsContainer) {
                 const card = document.createElement('div');
                 card.className = 'disaster-card';
                 card.innerHTML = `
                     <div class="card-header ${typeClass}"><h3>${sanitizeHtml(disaster.title || 'N/A')}</h3><span class="severity-indicator ${severityClass}">${severity}</span></div>
                     <div class="card-body">
                         <p><i class="fas fa-map-marker-alt"></i> ${location.substring(0, 50)}${location.length > 50 ? '...' : ''}</p>
                         <p><i class="far fa-clock"></i> ${formattedTime}</p>
                         <p class="card-description">${sanitizeHtml(disaster.description || '').substring(0,100)}...</p>
                     </div>
                     <div class="card-footer">
                         <button class="btn btn-sm view-details" data-id="${disaster.id || ''}"><i class="fas fa-eye"></i> Details</button>
                         <button class="btn btn-sm btn-icon share-event" data-id="${disaster.id || ''}"><i class="fas fa-share-alt"></i></button>
                     </div>`;
                  if (loadingOverlay) cardsContainer.insertBefore(card, loadingOverlay); else cardsContainer.appendChild(card);
            }
        });

        // Attach listeners to newly added buttons
        attachDetailAndShareListeners();
    } // End updateDisasterTable

    // Function to update statistics (called from map.js)
    function updateStatistics(filteredDisasters) {
        console.log("Updating statistics in index.html with", filteredDisasters.length, "items");
        const totalEl = document.getElementById('stat-total');
        const commonEl = document.getElementById('stat-common');
        const severeEl = document.getElementById('stat-severe');
        const newEl = document.getElementById('stat-new'); // Assumes this ID is for 'Last 7 Days' now

        if (!totalEl || !commonEl || !severeEl || !newEl) { console.warn("Stat elements not found."); return; }

        totalEl.textContent = filteredDisasters.length;
        if (filteredDisasters.length > 0) {
            const typeCounts = {};
            filteredDisasters.forEach(d => { typeCounts[d.type] = (typeCounts[d.type] || 0) + 1; });
            let mostCommonType = 'N/A'; let maxCount = 0;
            for (const type in typeCounts) { if (typeCounts[type] > maxCount) { maxCount = typeCounts[type]; mostCommonType = type.charAt(0).toUpperCase() + type.slice(1); } }
            commonEl.textContent = sanitizeHtml(mostCommonType);
            let highestSeverity = filteredDisasters.reduce((max, d) => Math.max(max, d.severity || 0), 0);
            severeEl.textContent = highestSeverity > 0 ? highestSeverity : 'N/A';
            // Count for the default 7-day filter period
            const cutoff = calculateCutoffDate(7); // Use helper from map.js scope? Or redefine here?
            const recentEvents = filteredDisasters.filter(d => d.timestamp && new Date(d.timestamp) >= cutoff).length;
            newEl.textContent = recentEvents;
        } else {
            commonEl.textContent = 'N/A'; severeEl.textContent = 'N/A'; newEl.textContent = 0;
        }
    } // End updateStatistics

     // Helper to calculate cutoff date (can be defined here or assume map.js defines it globally)
     function calculateCutoffDate(daysAgo) {
         const cutoff = new Date();
         cutoff.setDate(cutoff.getDate() - daysAgo);
         cutoff.setHours(0, 0, 0, 0);
         return cutoff;
     }

    // Helper to attach listeners to dynamic buttons
    function attachDetailAndShareListeners() {
         const dataArea = document.querySelector('.data-wrapper'); // Attach listener to wrapper
         if (!dataArea) return;

         // Remove previous listener to avoid duplicates if this is called multiple times
         dataArea.removeEventListener('click', handleActionClick);
         dataArea.addEventListener('click', handleActionClick);
    } // End attachDetailAndShareListeners

    // Single event handler for view/share buttons
    function handleActionClick(event) {
        const button = event.target.closest('button');
        if (!button) return;

        const id = button.getAttribute('data-id');
        if (!id) return;

        if (button.classList.contains('view-details')) {
            // Ensure viewDisasterDetails (from map.js) is available in the global scope
            if (typeof viewDisasterDetails === 'function') { viewDisasterDetails(id); }
            else { console.error("viewDisasterDetails function not found."); }
        } else if (button.classList.contains('share-event')) {
            console.log(`Sharing event ${id} (placeholder)`);
            alert(`Sharing for ID ${id} not implemented yet.`);
        }
    }


    // --- Add event listeners for index.html specific elements AFTER DOM is ready ---
    document.addEventListener('DOMContentLoaded', function() {
        console.log("Index.html specific DOMContentLoaded actions running.");

        // Filter toggle using details/summary
        const filterDetails = document.querySelector('.filter-details');
        if(filterDetails) {
            const summary = filterDetails.querySelector('summary');
            if (summary) {
                summary.addEventListener('click', (e) => {
                    // Optional: Update button text if needed, details handles expand/collapse
                    const toggleBtn = summary.querySelector('.filter-toggle-btn');
                     if(toggleBtn) {
                         setTimeout(() => { // Check state after browser updates open attribute
                             const isOpen = filterDetails.open;
                             const icon = toggleBtn.querySelector('i');
                             const text = toggleBtn.querySelector('span');
                             if(icon) icon.className = isOpen ? 'fas fa-chevron-up' : 'fas fa-chevron-down';
                             if(text) text.textContent = isOpen ? 'Hide Filters' : 'Show Filters';
                         }, 0);
                    }
                });
            }
        } else { console.warn("Filter details/summary elements not found."); }

        // View toggle buttons
        const tableViewBtn = document.getElementById('table-view');
        const cardViewBtn = document.getElementById('card-view');
        const dataWrapper = document.querySelector('.data-wrapper');
        if (tableViewBtn && cardViewBtn && dataWrapper) {
             tableViewBtn.addEventListener('click', function() {
                 if (!this.classList.contains('active')) {
                     this.classList.add('active'); cardViewBtn.classList.remove('active');
                     dataWrapper.classList.remove('card-view'); dataWrapper.classList.add('table-view');
                 }
             });
             cardViewBtn.addEventListener('click', function() {
                  if (!this.classList.contains('active')) {
                     this.classList.add('active'); tableViewBtn.classList.remove('active');
                     dataWrapper.classList.remove('table-view'); dataWrapper.classList.add('card-view');
                 }
             });
             // Set initial view (e.g., table)
             tableViewBtn.classList.add('active');
        } else { console.warn("Table/Card view toggle elements not found."); }

        // Other listeners (sorting, pagination placeholders)
        // ...

    }); // End index.html specific DOMContentLoaded

</script>
{# --- END Inline script --- #}
{% endblock %}